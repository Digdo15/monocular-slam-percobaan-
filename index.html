<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Client Deep SLAM Collector</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; color: white; }
        
        /* Video Preview (Kecil di pojok untuk debug) */
        #video-preview {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 120px;
            height: auto;
            border: 2px solid #0f0;
            z-index: 10;
            display: none; /* Disembunyikan, kita pakai canvas */
        }

        /* Overlay Status */
        #status-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 8px;
            z-index: 20;
            font-size: 12px;
        }
        .stat-row { margin-bottom: 4px; }
        .val { color: #0f0; font-weight: bold; }

        /* Tombol Start */
        #controls {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            z-index: 20;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        button:active { transform: scale(0.95); }
        button.stop { background: #dc3545; }

        /* 3D Viewer Container */
        #viewer3d { width: 100vw; height: 100vh; }
    </style>
</head>
<body>

    <div id="status-panel">
        <div class="stat-row">Status: <span id="conn-status" style="color:red">Disconnected</span></div>
        <div class="stat-row">GPS: <span id="gps-val" class="val">Waiting...</span></div>
        <div class="stat-row">FPS Kirim: <span id="fps-val" class="val">0</span></div>
        <div class="stat-row">Points: <span id="pts-val" class="val">0</span></div>
    </div>

    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <div id="viewer3d"></div>

    <div id="controls">
        <button id="btn-action">START STREAMING</button>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- KONFIGURASI ---
        // Ganti IP ini dengan IP Laptop/Server Python Anda
        const SERVER_URL = "http://192.168.1.5:5000"; 
        const FPS_TARGET = 10; // Jangan terlalu tinggi agar tidak lag

        // --- VARIABEL ---
        let socket;
        let streamActive = false;
        let intervalId;
        let gpsData = { lat: 0, lon: 0, alt: 0, acc: 0 };
        
        // Element
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const btn = document.getElementById('btn-action');
        const statusEl = document.getElementById('conn-status');
        const gpsEl = document.getElementById('gps-val');
        
        // --- 1. SETUP THREE.JS (VIEWER) ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10); // Posisi awal kamera viewer
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('viewer3d').appendChild(renderer.domElement);
        
        const controls = new OrbitControls(camera, renderer.domElement);
        
        // Point Cloud Placeholder
        const geometry = new THREE.BufferGeometry();
        const material = new THREE.PointsMaterial({ size: 0.05, vertexColors: true });
        let pointCloud = new THREE.Points(geometry, material);
        scene.add(pointCloud);

        // Grid Lantai untuk referensi
        const gridHelper = new THREE.GridHelper(20, 20);
        scene.add(gridHelper);

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // --- 2. SETUP WEBSOCKET & LOGIC ---
        
        function initSocket() {
            socket = io(SERVER_URL);

            socket.on('connect', () => {
                statusEl.innerText = "Connected";
                statusEl.style.color = "#0f0";
            });

            socket.on('disconnect', () => {
                statusEl.innerText = "Disconnected";
                statusEl.style.color = "red";
                stopStreaming();
            });

            // Menerima data 3D balik dari Server
            socket.on('update_map', (data) => {
                // data.points = array [x, y, z]
                // data.colors = array [r, g, b]
                updatePointCloud(data.points, data.colors);
                document.getElementById('pts-val').innerText = data.points.length / 3;
            });
        }

        // --- 3. KAMERA & GPS ---

        async function startCamera() {
            try {
                // Minta akses kamera belakang
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment", 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 } 
                    } 
                });
                video.srcObject = stream;
                await video.play();
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                return true;
            } catch (err) {
                alert("Gagal akses kamera: " + err);
                return false;
            }
        }

        function startGPS() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition((pos) => {
                    gpsData = {
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude,
                        alt: pos.coords.altitude || 0,
                        acc: pos.coords.accuracy
                    };
                    gpsEl.innerText = `${gpsData.lat.toFixed(5)}, ${gpsData.lon.toFixed(5)}`;
                }, (err) => console.error(err), { enableHighAccuracy: true });
            }
        }

        // --- 4. LOOP PENGIRIMAN DATA ---

        function sendFrame() {
            if (!streamActive) return;

            // Gambar video ke canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Konversi ke JPG Base64 (Kualitas 0.7 untuk kecepatan)
            const imageData = canvas.toDataURL("image/jpeg", 0.7);

            // Kirim paket ke server
            socket.emit('process_frame', {
                image: imageData,
                gps: gpsData,
                timestamp: Date.now()
            });
        }

        // --- 5. VISUALISASI POINT CLOUD ---
        function updatePointCloud(points, colors) {
            const positions = new Float32Array(points);
            const cols = new Float32Array(colors);
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(cols, 3));
            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;
        }

        // --- 6. BUTTON HANDLER ---
        btn.addEventListener('click', async () => {
            if (!streamActive) {
                // START
                initSocket(); // Connect ke server
                const camReady = await startCamera();
                if (camReady) {
                    startGPS();
                    streamActive = true;
                    btn.innerText = "STOP STREAMING";
                    btn.classList.add('stop');
                    
                    // Mulai loop pengiriman
                    intervalId = setInterval(sendFrame, 1000 / FPS_TARGET);
                }
            } else {
                // STOP
                stopStreaming();
            }
        });

        function stopStreaming() {
            streamActive = false;
            clearInterval(intervalId);
            btn.innerText = "START STREAMING";
            btn.classList.remove('stop');
            if (socket) socket.disconnect();
            
            // Matikan kamera
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>